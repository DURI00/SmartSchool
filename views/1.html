<head>
  <link href="css/dropdown.css" rel="stylesheet" type="text/css" />

  <!--craftmap-->
  <link href="vender/craftmap/css/default.css" rel="stylesheet" type="text/css" />
  <link href="vender/craftmap/css/demo1.css" rel="stylesheet" type="text/css" />
 

</head>

      <div class="row">
        <div class="col-lg-12">
          <h1 class="page-header"><span id="nowTime"></span> 학교 환경정보</h1>
        </div>
        <!-- /.col-lg-12 -->
      </div>
      <!-- /.row -->
      <div class="row">
        <div class="col-lg-12">
          <!-- craftmap -->
          <div id="content">
            <div class="relative">
              <div class="demo1">
                <img src="images/Nschool.png" class="imgMap" />
              </div>
              <div class="controls">
                <div class="tab">
                  <button class="tablinks" onclick="openCity(event, 'GeneralClass')">일반교실</button>
                  <button class="tablinks" onclick="openCity(event, 'SpecialClass')">특별교실</button>
                </div>

                <div id="GeneralClass" class="tabcontent">
                </div>

                <div id="SpecialClass" class="tabcontent">
                </div>

                <!--button onclick="myFunction()" class="dropbtn">일반교실</button>
                <div id="myDropdown" class="dropdown-content">
                </div-->
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-12" style="font-size: 9pt;">
          <input type="text" id="myInput" onkeyup="tbFilter()" placeholder="Search for datas.." title="Type in a name">
          <span id="rowCnt"> 0</span>
          <table class="table table-bordered text-center table-scrollable table-hover table-fixed" id="sensor_table" style="margin-bottom: 0px;">
            <thead class="fixed_thead">
              <tr>
                <td colspan="2">Sensor Info</td>
                <td colspan="3">Realtime Sensor Data</td>
              </tr>
              <tr>
                <td width="13%">location</td>
                <td width="26%">Mac</td>
                <td width="17%">Type</td>
                <td width="17%">Data</td>
                <td width="27%">Time</td>
              </tr>
            </thead>
            <tbody id="sensor_table_tbody">
            </tbody>
          </table>
        </div>
      </div>


<!--jquery 버전 충돌 방지 https://www.cmsfactory.net/node/10494 -->
<script src="vender/craftmap/js/jquery.js" type="text/javascript"></script>
<script>
$.getJSON("/api/class-data" , function(data) {
  var addMarker = "",
      addControl_1 = "",
      addControl_2 = "";
  $.each(data, function(r, vr) { //행:[{...}, ...]의 개수 만큼 반복  
    var V = vr.LOC, X = vr.x-10, Y = vr.y-20;
    addMarker += "<div class=\"marker\" id="+V+" data-coords="+vr.x+","+vr.y+"><h3>"+V+"</h3><div class=\"popup_Contents\" >"+
    "<table width=\"100%\"><tr><td><img src=\"images/temp.png\"/></td><td style = \"width : 110px\">temperature<p class =\"온도\"> - </p></td><td><img src=\"images/humi.png\"/></td><td style = \"width : 110px\">humidity<p class =\"습도\"> - </p></td></tr><tr><td><img src=\"images/noise.png\"/></td><td>dust<p class =\"미세먼지\"> - </p></td><td><img src=\"images/co2.png\"/></td><td>co2<p class =\"이산화탄소\"> - </p></td></tr></table></div></div>";
    V.substring(1,3) == "학년" ? addControl_1 += "<a rel="+V+">"+V+"</a>" : addControl_2 += "<a rel="+V+">"+V+"</a>"//https://joshua1988.github.io/web_dev/javascript-best-practices/#ternary-conditional-삼항-연산자
  })
  $("#GeneralClass").append(addControl_1);
  $("#SpecialClass").append(addControl_2);
  $(".demo1").append(addMarker);
  update_data() //초기 테이블 생성
  document.getElementById("rowCnt").innerHTML = $("#sensor_table_tbody tr").length;//초기 테이블 생성 시 개수 계산
  $('.demo1').craftmap({ //DRAW MAP
    image: {
      width: 3060,//5247,
      height: 600
    }
  });
})

//타입에 따른 Data 값 변환
function transeData(tempType,v){
  switch(tempType){//https://joshua1988.github.io/web_dev/javascript-best-practices/#switch-blocks
    case "미세먼지" : v+=" μg/㎥";
     break;
    case "습도" : v=v/10; v+=" ％";
     break;
    case "온도" : v=v/10; v+=" ℃";
      break;
    case "이산화탄소" : v+=" ppm";
     break;
    case "초미세먼지" : v+=" μg/㎥";
     break;
    default : v+="";//" ?";
  }
  return v;
}

//function update_data() {데이블 갱신!
//모든 테이블을 계속해서 $().html()로 새로 갱신하니까, 문제가 생겼다.
//문제점 1. myInput이라는 text form의 값을 이용해 tr들을 hidden처리하던 부분이 적용되지 않는다.
//문제점 2. 그렇다고 생성된 테이블에 td값만을 갱신하고자 하면, 갱신이 아닌, 센서값이 처음 들어와서 새로 추가되는 row들을 처리할 수 없음.(오류 발생할듯)
//    --> 센서값이 추가적으로 입력된 경우 sensor_data_update 부분도 추가 되므로, 오류 발생해도, 페이지 새로고침 할 것을 염두하고 무시하고 할까? 
//    --> 센서값이 추가될 때, 조건문을 달아 tr을 추가할까? --> 순서까지 변경해줘야하고 코드가 복잡해짐.
//해결방안 1. update_date()에서 테이블 갱신시, myInput값을 받아와 CLASS_NAME과 비교하여, tr을 hidden 처리 하자. 
var interval = setInterval(update_data, 5000); //5초마다 갱신
function update_data() {
  //다른 페이지 접속 시 인터벌 종료하기 위함...ㅠ;
  if(document.getElementById("myInput") === null) {
    clearInterval(interval);
    return false;//출처: http://tkjeon.tistory.com/entry/setInterval-함수의-온오프-ONOFF [TRUE WEB];
  }
  $.getJSON("/api/sensor-data" , function(data) {
    var tbl_body = "";
    var input = document.getElementById("myInput");
    var filter = input.value.toUpperCase();
    $.each(data, function() {
      var tbl_row = "";
      var tbl_disp = "";
      var tempId, tempType;
      $.each(this, function(k , v) {
        switch(k){//swich vs else if => https://joshua1988.github.io/web_dev/javascript-best-practices/#switch-blocks
          case "LOC" :
            tempId = v;
            //테이블 갱신 시, myInput에 따른 테이블 hidden 처리...
            if (v.toUpperCase().indexOf(filter) > -1) {//indexOf는 일치하지 않는 값이 있으면 -1 반환
              tbl_disp = "";
            } else {
              tbl_disp = "style=\"display: none;\"";
            }
            tbl_row = tbl_row+tbl_disp+"class = "+v+">";
            tbl_row += "<td>"+v+"</td>";
            break;
          case "TIME" : 
              if(moment().diff(v, 'minutes') >= 10 || v == null){
                tbl_row += "<td style=\"color:Tomato;\">"+moment(v).fromNow()+"</td>";
                $(".marker#"+tempId).css("background", "url(../images/red-wifi-32.png) no-repeat");
              }
              else{tbl_row += "<td>"+moment(v).fromNow()+"</td>";}
            break;
          case "TYPE" :
            v == null ? v = "-" : tempType = v;
            tbl_row += "<td>"+v+"</td>";
            break;
          case "DATA" :
            v = v == null ? "-" : transeData(tempType,v);//타입에 따른 부호 추가
            tbl_row += "<td>"+v+"</td>";
            $(".marker#"+tempId+" .popup_Contents p."+tempType).text(v);
            break;
          default : tbl_row += "<td>"+v+"</td>";
        }
      })
      tbl_body += "<tr "+tbl_row+"</tr>";
    })
    $("#sensor_table_tbody").html(tbl_body);
  });
  return false;
}

//https://www.w3schools.com/howto/howto_js_filter_table.asp
function tbFilter() {
  var input, filter, table, tr, td, displayCnt=0;
  input = document.getElementById("myInput");
  filter = input.value.toUpperCase();
  table = document.getElementById("sensor_table_tbody");
  tr = table.getElementsByTagName("tr");
  for (var i = 0, l = tr.length; i < l; i++) {
    td = tr[i].getElementsByTagName("td");
    for(var j = 0; j < 3; j++) {// Type까지만.... td.length; j++) {
      if (td[j]) {
        if (td[j].innerHTML.toUpperCase().indexOf(filter) > -1) {//indexOf는 일치하지 않는 값이 있으면 -1 반환
          tr[i].style.display = "";
          displayCnt++;
          break;
        } else {
          tr[i].style.display = "none";
        }
      }
    }       
  }
  document.getElementById("rowCnt").innerHTML = displayCnt;//필터 사용 후 개수 계산
}

//https://www.w3schools.com/howto/howto_js_tabs.asp
function openCity(evt, cityName) {
  var tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (var i = 0, l = tabcontent.length; i < l; i++) {
    if(cityName == tabcontent[i].id )
      tabcontent[i].classList.toggle("show"); //https://www.w3schools.com/jsref/prop_element_classlist.asp
    else{
      if (tabcontent[i].classList.contains('show')) {
        tabcontent[i].classList.remove('show');
      }
    }
  }
}

// Close the dropdown if the user clicks outside of it
window.onclick = function(event) {
  if (!event.target.matches('.tablinks')) {//dropbtn')) {
    var dropdowns = document.getElementsByClassName("tabcontent");
  for (var i = 0, l = dropdowns.length; i < l; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}


/* https://www.w3schools.com/howto/tryit.asp?filename=tryhow_css_js_dropdown
When the user clicks on the button, 
toggle between hiding and showing the dropdown content */
// function myFunction() {
//   document.getElementById("myDropdown").classList.toggle("show"); //show라는 클래스를 추가, 다시 클릭 하면, 삭제
// }

/* craftmap의 click이벤트 live()와 겹쳐서... 사용 불가했음.. ㅠㅠ;
$(document).ready(function(){
    $("div.popup").delegate("a", "click",function(){
        $("p").css("background-color", "pink");
    });
});
$("#myDropdown").delegate("a","click",function () {
  console.log($(this).text());
  alert('aa');
 document.getElementById("myInput").value = $(this).text();
 tbFilter();
});
*/
//https://stackoverflow.com/questions/1051061/convert-json-array-to-an-html-table-in-jquery

  
</script>
<script src="vender/craftmap/js/craftmap2.js" type="text/javascript"></script>   